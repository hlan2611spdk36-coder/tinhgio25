<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chinh Ph·ª•c T√≠nh Gi·ªù - GV H·ªì Th·ªã Lan</title>
    <!-- Nh√∫ng font ch·ªØ: Nunito, Barlow Condensed, Alfa Slab One, Roboto -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&family=Barlow+Condensed:wght@800;900&family=Alfa+Slab+One&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #e74c3c; 
            --secondary: #00cec9;
            --accent: #fdcb6e;
            --success: #2ecc71;
            --danger: #fab1a0;
            --dark: #2d3436;
            --light: #f9f9f9;
            --sidebar-width: 105px; 
            --footer-gray-light: #bdc3c7;
            --footer-gray-dark: #555555;
            
            --sidebar-bg: #d1e9ff; /* Xanh nh·∫°t Pastel cho Sidebar */
            --main-area-bg: #fff9db; /* V√†ng Pastel cho khu v·ª±c ch√≠nh */
            --sidebar-label-color: #2980b9;
            --welcome-blue: #2980b9; 
            --rank-bg: #2980b9; 
            
            /* M√†u n·ªÅn c√°c khung c√†i ƒë·∫∑t ri√™ng bi·ªát */
            --bg-class: #fdf2f2; /* H·ªìng nh·∫°t */
            --bg-rank: #f0fff4;  /* Xanh l√° nh·∫°t */
            --bg-gift: #f5f3ff;  /* T√≠m nh·∫°t */
            --bg-sound: #fffaf0; /* Cam nh·∫°t */
            
            /* M√†u n√∫t ƒëi·ªÅu h∆∞·ªõng xanh l√° pastel */
            --nav-btn-bg: #a8e6cf; 
            --nav-btn-hover: #81c784;
        }

        /* ƒê·ªãnh nghƒ©a font ch·ªØ t√πy ch·ªânh SFU Futura */
        @font-face {
            font-family: '#9Slide03 SFU Futura_12';
            src: local('SFU Futura'), local('Futura'), local('Arial'), sans-serif;
        }

        /* ƒê·ªãnh nghƒ©a font ch·ªØ #9Slide03 Bebas Neue Bold (d·ª± ph√≤ng) */
        @font-face {
            font-family: '#9Slide03 Bebas Neue Bold';
            src: local('Bebas Neue Bold'), local('BebasNeue-Bold'), local('Bebas Neue'), sans-serif;
        }

        * { box-sizing: border-box; transition: all 0.2s ease; font-family: 'Nunito', sans-serif; }

        body {
            background: linear-gradient(135deg, #74b9ff, #a29bfe);
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; margin: 0; padding: 15px;
        }

        #game-wrapper {
            background: white; width: 100%; max-width: 1250px; height: 95vh;
            border-radius: 40px; box-shadow: 0 25px 60px rgba(0,0,0,0.3);
            overflow: hidden; border: 10px solid rgba(255,255,255,0.4);
            display: flex; position: relative;
        }

        /* Sidebar Xanh Pastel */
        #left-sidebar {
            width: var(--sidebar-width); background: var(--sidebar-bg);
            display: flex; flex-direction: column; align-items: center;
            padding: 20px 0; gap: 8px; z-index: 100;
            overflow-y: auto; height: 100%; scrollbar-width: none; flex-shrink: 0;
            border-right: 1px solid rgba(0,0,0,0.05);
            /* NEW: Cho ph√©p k√©o chu·ªôt */
            cursor: grab;
            user-select: none; /* Tr√°nh b√¥i ƒëen khi k√©o */
        }
        #left-sidebar::-webkit-scrollbar { display: none; }
        #left-sidebar:active { cursor: grabbing; }

        .sidebar-btn {
            width: 70px; height: 70px; border-radius: 22px;
            background: rgba(255,255,255,0.6); color: var(--welcome-blue);
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; font-size: 30px; border: none;
            box-shadow: 0 4px 0 rgba(0,0,0,0.05); flex-shrink: 0;
            /* Tr√°nh nh·∫≠n s·ª± ki·ªán chu·ªôt khi ƒëang k√©o sidebar */
            pointer-events: auto; 
        }
        .sidebar-btn:hover { background: white; transform: scale(1.05); }
        .sidebar-label { font-size: 11px; color: var(--sidebar-label-color); text-transform: uppercase; font-weight: 800; text-align: center; margin-bottom: 10px; flex-shrink: 0; line-height: 1.2; user-select: none; }

        #main-content { 
            flex: 1; 
            overflow-y: auto; 
            background: var(--main-area-bg); 
            display: flex; 
            flex-direction: column; 
            padding-bottom: 50px; /* FIX: Th√™m padding d∆∞·ªõi c√πng ƒë·ªÉ tr√°nh n·ªôi dung b·ªã che khu·∫•t khi scroll */
        }

        /* Ti√™u ƒë·ªÅ ch√≠nh */
        .special-title-container {
            position: relative; padding: 35px; display: flex; justify-content: center;
            align-items: center; overflow: hidden; background: #fff; min-height: 130px; border-bottom: 2px solid #eee;
        }
        .rainbow-shine {
            position: absolute; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.8), transparent);
            transform: skewX(-20deg); animation: shine 6s infinite; z-index: 2;
        }
        @keyframes shine { 0% { left: -150%; } 100% { left: 250%; } }

        .main-title {
            position: relative; z-index: 4; font-family: 'Barlow Condensed', sans-serif;
            font-weight: 900; font-size: 64px; color: var(--primary); text-align: center;
            text-transform: uppercase; letter-spacing: -1px; line-height: 1;
            text-shadow: -3px -3px 0 #fff, 3px -3px 0 #fff, -3px 3px 0 #fff, 3px 3px 0 #fff,
                1px 1px 0px #c0392b, 2px 2px 0px #c0392b, 3px 3px 0px #c0392b, 
                4px 4px 0px #c0392b, 6px 6px 15px rgba(0,0,0,0.15);
        }

        /* Card Th√¥ng tin h·ªçc sinh */
        .player-info-card { display: flex; align-items: center; justify-content: center; gap: 25px; background: white; padding: 20px; border-radius: 25px; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); position: relative; }
        .avatar-circle { width: 100px; height: 100px; background: transparent; border: none; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .avatar-circle svg { width: 100%; height: 100%; }
        #player-display { color: var(--primary) !important; font-weight: 900; font-size: 26px; }

        .rank-label { background: var(--rank-bg); color: white !important; padding: 8px 22px; border-radius: 15px; font-weight: 900; font-size: 16px; margin-top: 8px; display: inline-block; }
        .rank-desc { font-style: italic; color: #bdc3c7; font-size: 13px; font-weight: 400; margin-top: 5px; line-height: 1.2; max-width: 350px; }

        /* N√öT ƒêI·ªÄU H∆Ø·ªöNG T√ôY CH·ªàNH */
        .btn-nav-custom {
            background-color: var(--nav-btn-bg) !important;
            color: white !important;
            font-family: 'Barlow Condensed', sans-serif !important;
            font-weight: 900 !important; /* Barlow Condensed ExtraBold */
            text-transform: uppercase;
            border: none !important;
            padding: 12px 30px;
            border-radius: 20px;
            cursor: pointer;
            box-shadow: 0 4px 0 rgba(0,0,0,0.05);
            font-size: 20px;
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            /* FIX: NgƒÉn ch·∫∑n co ch·ªØ v√† xu·ªëng d√≤ng */
            white-space: nowrap;
            flex-shrink: 0;
        }
        .btn-nav-custom:hover { background-color: var(--nav-btn-hover) !important; transform: translateY(-2px); }
        .btn-nav-custom:active { transform: translateY(2px); box-shadow: none; }

        /* N√öT N·ªòP B√ÄI M√ÄU ƒê·ªé */
        #submit-btn { background-color: var(--primary) !important; }

        /* L·ªùi gi·∫£i & K·∫øt qu·∫£ */
        .action-container { text-align: center; background: #fff; padding: 30px; border-radius: 35px; border: 4px solid var(--btn-pastel-secondary); box-shadow: 0 15px 30px rgba(0,0,0,0.05); }
        #result-area { margin-top: 25px; padding: 30px; border-radius: 30px; display: none; text-align: left; animation: slideUp 0.5s ease-out; box-shadow: inset 0 2px 10px rgba(0,0,0,0.05); }
        
        .solution-list { list-style: none; padding: 0; margin: 0; }
        .solution-step { 
            margin-bottom: 12px; padding-left: 25px; position: relative; 
            font-family: 'Roboto', sans-serif; 
            font-weight: 300; /* Roboto Light */
            color: black !important;
            font-size: 1.1em;
            line-height: 1.6;
        }
        .solution-step::before { content: '*'; position: absolute; left: 0; top: 0; font-size: 22px; font-weight: bold; }

        /* K·∫æT QU·∫¢: SFU Futura, xanh d∆∞∆°ng t∆∞∆°i s√°ng, Gi·ªù/Ng√†y m√†u ƒë·ªè in ƒë·∫≠m */
        .final-answer-block { 
            background: white !important; 
            border: none !important; 
            border-radius: 20px;
            padding: 20px; 
            margin-top: 20px; 
            font-family: '#9Slide03 SFU Futura_12', sans-serif !important; 
            font-weight: 400 !important; 
            color: #00aaff !important; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        .final-answer-block b, .final-answer-block .ans-red { font-weight: 700 !important; color: var(--primary) !important; }

        /* C√ÄI ƒê·∫∂T: Chia th√†nh 4 √¥ l∆∞·ªõi chuy√™n nghi·ªáp */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }
        .settings-card { 
            padding: 30px; border-radius: 35px; border: 1px solid rgba(0,0,0,0.05);
            box-shadow: 0 5px 20px rgba(0,0,0,0.02); height: auto;
        }
        .card-class { background-color: var(--bg-class); }
        .card-rank { background-color: var(--bg-rank); }
        .card-gift { background-color: var(--bg-gift); }
        .card-sound { background-color: var(--bg-sound); }

        .correct-box { background: #f0fff4; border: 4px solid var(--success); }
        .wrong-box { background: #fff5f5; border: 4px solid var(--primary); }

        input, select, textarea { width: 100%; padding: 14px; border-radius: 15px; border: 2px solid #eee; margin-bottom: 10px; outline: none; font-size: 16px; font-weight: 700; }
        input::placeholder, textarea::placeholder { color: var(--footer-gray-light) !important; font-size: 13px !important; font-style: italic !important; font-weight: 400 !important; }
        
        .upload-wrapper { background: #fff; border: 2px dashed #ddd; border-radius: 20px; padding: 15px; margin-bottom: 20px; text-align: left; }
        .custom-file-input { font-size: 12px !important; font-style: italic !important; color: var(--footer-gray-light) !important; padding: 5px !important; border: 1px solid #eee !important; background: #fff; width: 100%; }
        .custom-file-input::file-selector-button { background: #f0f0f0; border: 1px solid #ddd; border-radius: 8px; font-size: 11px; padding: 4px 8px; cursor: pointer; margin-right: 10px; color: #777; }
        .btn-add-gift-cute { background: #d1e9ff !important; border: none !important; width: 42px; height: 42px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .rank-point-input { width: 85px !important; padding: 8px !important; font-size: 15px !important; margin: 0 !important; height: auto !important; }

        .screen { display: none; padding: 30px; animation: fadeIn 0.4s ease-out; }
        .active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* FOOTER */
        .footer { text-align: center; padding: 30px; background: #fff; margin-top: auto; border-top: 1px solid #eee; }
        .footer-line-1 { font-weight: 900; color: var(--footer-gray-dark); font-size: 16px; margin-bottom: 12px; }
        .footer-line-2 { display: flex; justify-content: center; align-items: center; gap: 25px; flex-wrap: wrap; font-style: italic; color: var(--footer-gray-light); font-size: 14px; }
        .footer-item { display: flex; align-items: center; gap: 8px; }
        .footer-icon { width: 18px; height: 18px; fill: var(--footer-gray-light); }

        .game-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-content { background: white; padding: 35px; border-radius: 35px; text-align: center; width: 90%; max-width: 600px; border: 8px solid var(--sidebar-bg); max-height: 85vh; overflow-y: auto; }

        .manage-list { max-height: 180px; overflow-y: auto; background: #fdfdfd; border-radius: 15px; border: 1px solid #eee; padding: 10px; margin-top: 10px; }
        .manage-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; background: white; margin-bottom: 5px; border-radius: 8px; }
        
        .answer-inputs-wrapper { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .input-box-container { display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .input-box-container label { font-size: 12px; font-weight: 800; color: #777; text-transform: uppercase; }
        .ans-field { width: 80px; text-align: center; font-size: 28px; font-weight: 900; border: 4px solid var(--secondary); padding: 10px; border-radius: 15px; }
        .ans-field-year { width: 110px; }

        /* Trung t√¢m ƒë·ªïi qu√† */
        .gift-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-top: 20px; }
        .gift-card { background: white; border-radius: 30px; padding: 25px; text-align: center; box-shadow: 0 10px 20px rgba(0,0,0,0.05); border: 5px solid white; transition: 0.3s; position: relative; }
        .gift-card:hover { transform: translateY(-10px); }
        .gift-image-box { width: 100px; height: 100px; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; overflow: hidden; border-radius: 20px; background: #f9f9f9; }
        .gift-image-box img { width: 100%; height: 100%; object-fit: cover; }

        .switch { position: relative; display: inline-block; width: 54px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(26px); }

        #image-preview-setup { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; display: none; margin-top: 5px; border: 2px solid var(--secondary); }
        #msg-box { position: fixed; top: 30px; right: 30px; padding: 20px 50px; border-radius: 60px; color: white; font-weight: 900; display: none; z-index: 4000; box-shadow: 0 15px 30px rgba(0,0,0,0.2); text-transform: uppercase; font-size: 22px; }
        .btn-delete-red { background-color: var(--primary) !important; color: white !important; border: none !important; padding: 5px 12px; font-size: 12px; border-radius: 10px; cursor: pointer; font-weight: 900; }
        
        .welcome-text { font-family: 'Alfa Slab One', cursive; color: #2980b9; font-size: 32px; margin-bottom: 20px; }
        .input-group { margin-bottom: 15px; text-align: left; }
        
        .map-box { margin-bottom: 20px; border-radius: 20px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border: 4px solid white; }
        .map-box img { width: 100%; display: block; }
        
        .control-panel { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; background: rgba(255,255,255,0.7); padding: 15px; border-radius: 20px; }
        .control-panel div { display: flex; flex-direction: column; align-items: flex-start; }
        .control-panel label { font-size: 12px; font-weight: 800; color: #555; margin-bottom: 4px; }
        
        /* Leaderboard Table */
        .leaderboard-table { width: 100%; border-collapse: collapse; }
        .leaderboard-table th, .leaderboard-table td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        .leaderboard-table th { background-color: #f0f0f0; color: #333; font-weight: 800; border-radius: 8px; }
        .leaderboard-table tr:hover { background-color: #f9f9f9; }

        /* CONFETTI CANVAS */
        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }
    </style>
</head>
<body>

<div id="msg-box"></div>
<canvas id="confetti-canvas"></canvas>

<!-- MODALS -->
<div id="sound-modal" class="game-modal">
    <div class="modal-content">
        <h2 style="font-family: 'Barlow Condensed', sans-serif; font-weight: 900; color: #2980b9; font-size: 32px;">ƒêO ƒê·ªò ·ªíN L·ªöP H·ªåC</h2>
        <div style="width: 100%; height: 40px; background: #eee; border-radius: 20px; margin: 20px 0; overflow: hidden;"><div id="meter-bar" style="width: 0%; height: 100%; background: var(--success); transition: 0.1s;"></div></div>
        <p id="noise-level-text" style="font-size: 28px; font-weight: 900; color: var(--success);">Y√äN Tƒ®NH</p>
        <p id="db-display" style="font-weight: 800; color: #aaa;">0 dB</p>
        <button class="btn btn-nav-custom" onclick="window.hideSoundModal()">ƒê√ìNG</button>
    </div>
</div>

<div id="timer-modal" class="game-modal">
    <div class="modal-content">
        <h2 style="font-family: 'Barlow Condensed', sans-serif; font-weight: 900; color: #2980b9; margin-top:0; font-size: 32px;">ƒê·ªíNG H·ªí B·∫§M GI·ªú</h2>
        <div id="modalTimerDisplay" style="font-size: 60px; font-weight: 900; color: var(--dark); margin: 20px 0;">00:00:00</div>
        <div style="display:flex; justify-content:center; gap:10px; margin-bottom: 20px;">
            <button class="btn btn-nav-custom" onclick="window.startTimer()">B·∫ÆT ƒê·∫¶U</button>
            <button class="btn btn-nav-custom" style="background-color: var(--accent) !important;" onclick="window.stopTimer()">D·ª™NG</button>
            <button class="btn btn-nav-custom" style="background-color:#aaa !important;" onclick="window.resetTimer()">XO√Å</button>
        </div>
        <button class="btn btn-nav-custom" onclick="window.hideTimerModal()">QUAY L·∫†I</button>
    </div>
</div>

<div id="random-call-modal" class="game-modal">
    <div class="modal-content">
        <h2 style="font-family: 'Barlow Condensed', sans-serif; font-weight: 900; color: #2980b9; margin-top:0; font-size: 32px;">G·ªåI T√äN NG·∫™U NHI√äN</h2>
        <select id="modal-rc-class" style="margin-bottom:20px;"></select>
        <div id="modalRandomResult" style="font-size: 40px; font-weight: 900; color: var(--primary); min-height: 80px; display: flex; align-items: center; justify-content: center; background: #fff9f9; border-radius: 20px; margin-bottom: 20px; border: 2px dashed #ffaaa5;">B·∫•m ƒë·ªÉ g·ªçi</div>
        <button class="btn btn-nav-custom" onclick="window.pickRandomModal()">QUAY S·ªê üé≤</button>
        <button class="btn btn-nav-custom" style="background:#aaa !important; margin-left: 10px;" onclick="window.hideRandomCallModal()">ƒê√ìNG</button>
    </div>
</div>

<!-- NEW: Confirmation Modal -->
<div id="confirm-modal" class="game-modal">
    <div class="modal-content">
        <h3 id="confirm-msg" style="margin-bottom: 20px; color: var(--primary); font-family: 'Nunito', sans-serif; font-weight: 800; font-size: 20px;">B·∫°n c√≥ ch·∫Øc ch·∫Øn?</h3>
        <div style="display:flex; justify-content:center; gap:15px;">
            <button id="confirm-yes-btn" class="btn btn-nav-custom" style="background-color: var(--primary) !important;">ƒê·ªíNG √ù</button>
            <button onclick="window.closeConfirmModal()" class="btn btn-nav-custom" style="background-color: #aaa !important;">H·ª¶Y</button>
        </div>
    </div>
</div>

<!-- NEW: Focus Warning Modal -->
<div id="focus-warning-modal" class="game-modal">
    <div class="modal-content" style="border-color: var(--primary);">
        <div style="font-size: 50px;">‚ö†Ô∏è</div>
        <h2 style="font-family: 'Barlow Condensed', sans-serif; font-weight: 900; color: var(--primary); margin-top: 10px; font-size: 32px;">C·∫¢NH B√ÅO</h2>
        <p style="font-weight: 700; color: #555; margin-bottom: 20px; font-size: 18px;">B·∫°n v·ª´a r·ªùi kh·ªèi m√†n h√¨nh l√†m b√†i.<br>Vui l√≤ng t·∫≠p trung v√† kh√¥ng chuy·ªÉn tab!</p>
        <button class="btn btn-nav-custom" onclick="document.getElementById('focus-warning-modal').style.display='none'">ƒê√É HI·ªÇU</button>
    </div>
</div>

<!-- AUDIO -->
<audio id="sound-correct-default" src="https://cdn.pixabay.com/audio/2021/08/04/audio_bbd151121d.mp3"></audio>
<audio id="sound-wrong-default" src="https://cdn.pixabay.com/audio/2022/03/10/audio_c35278d30e.mp3"></audio>
<audio id="sound-click" src="https://cdn.pixabay.com/audio/2022/03/15/audio_7838cf3877.mp3"></audio>
<audio id="sound-bg-loop" loop></audio>

<div id="game-wrapper">
    <!-- Sidebar -->
    <div id="left-sidebar">
        <button class="sidebar-btn" onclick="window.openHome()" title="Trang ch·ªß">üè†</button><span class="sidebar-label">Trang ch·ªß</span>
        <button class="sidebar-btn" onclick="window.resetClassScores()" title="ƒê·∫∑t l·∫°i ƒëi·ªÉm l·ªõp">üîÑ</button><span class="sidebar-label">ƒê·∫∑t l·∫°i ƒëi·ªÉm</span>
        <button class="sidebar-btn" onclick="window.showTimerModal()" title="B·∫•m gi·ªù">‚è±Ô∏è</button><span class="sidebar-label">B·∫•m gi·ªù</span>
        <button class="sidebar-btn" onclick="window.showRandomCallModal()" title="G·ªçi t√™n">üé≤</button><span class="sidebar-label">G·ªçi t√™n</span>
        <button class="sidebar-btn" onclick="window.showSoundModal()" title="ƒêo ƒë·ªô ·ªìn">üîä</button><span class="sidebar-label">ƒêo ti·∫øng</span>
        <button class="sidebar-btn" onclick="window.exportToExcel()" title="Xu·∫•t Excel">üìä</button><span class="sidebar-label">Excel</span>
        <button class="sidebar-btn" onclick="window.showLeaderboard()" title="B·∫£ng th√†nh t√≠ch">üèÜ</button><span class="sidebar-label">B·∫£ng v√†ng</span>
        <button class="sidebar-btn" onclick="window.showShop()" title="ƒê·ªïi qu√† t·∫∑ng">üéÅ</button><span class="sidebar-label">ƒê·ªïi qu√†</span>
        <div style="flex-grow: 1;"></div>
        <button class="sidebar-btn" onclick="window.openSettings()" title="C√†i ƒë·∫∑t h·ªá th·ªëng">‚öôÔ∏è</button><span class="sidebar-label">C√†i ƒë·∫∑t</span>
    </div>

    <div id="main-content">
        <div id="dynamic-header" class="special-title-container"><div class="rainbow-shine"></div><h1 class="main-title">CHINH PH·ª§C T√çNH GI·ªú</h1></div>

        <!-- M√ÄN H√åNH CH∆†I -->
        <div id="game-screen" class="screen">
            <div class="player-info-card">
                <div class="avatar-circle" id="player-avatar"></div>
                <div style="text-align: left;">
                    <div id="player-display">...</div>
                    <div style="color: #7f8c8d; font-weight: 700; font-size: 18px;">L·ªõp: <span id="class-display">...</span></div>
                    <div class="rank-label" id="rank-display">ONG TH∆Ø·ªúER</div>
                    <div class="rank-desc" id="rank-desc-display">...</div>
                </div>
                <div style="margin-left: auto; text-align: right;"><div style="font-size: 14px; font-weight: 800; color: #aaa;">ƒêI·ªÇM S·ªê</div><div style="font-size: 46px; font-weight: 900; color: var(--primary);" id="player-score">0</div></div>
            </div>
            
            <div class="map-box"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/8/88/World_Time_Zones_Map.png/1200px-World_Time_Zones_Map.png" alt="Map"></div>
            <div class="control-panel"><div><label>üìç N∆∞·ªõc m·ªëc:</label><select id="country-from" onchange="window.updateCalculations()"></select></div><div><label>üéØ N∆∞·ªõc t√≠nh:</label><select id="country-to" onchange="window.updateCalculations()"></select></div></div>
            <div id="question-text" style="text-align:center; font-size: 1.8em; margin: 25px 0; min-height:60px;"></div>

            <div class="action-container">
                <div id="input-container">
                    <div class="answer-inputs-wrapper">
                        <div class="input-box-container"><label>Gi·ªù</label><input type="number" id="ans-hour" class="ans-field" placeholder="?"></div>
                        <div class="input-box-container"><label>Ng√†y</label><input type="number" id="ans-day" class="ans-field" placeholder="?"></div>
                        <div class="input-box-container"><label>Th√°ng</label><input type="number" id="ans-month" class="ans-field" placeholder="?"></div>
                        <div class="input-box-container"><label>NƒÉm</label><input type="number" id="ans-year" class="ans-field ans-field-year" placeholder="?"></div>
                    </div>
                    <!-- FIX: Th√™m flex-wrap: wrap ƒë·ªÉ tr√°nh b·ªã m·∫•t n√∫t khi m√†n h√¨nh nh·ªè -->
                    <div style="display: flex; justify-content: center; gap: 15px; align-items: center; flex-wrap: wrap;">
                        <button class="btn btn-nav-custom" id="submit-btn" onclick="window.submitAnswer()">N·ªòP B√ÄI üìù</button>
                        <button class="btn btn-nav-custom" id="next-btn" onclick="window.randomize()" style="display:none; background-color: #2980b9 !important;">C√ÇU TI·∫æP THEO ‚è≠Ô∏è</button>
                    </div>
                </div>
                <div id="result-area">
                    <div class="solution-title" id="result-message" style="font-size: 20px; font-weight: 900; margin-bottom: 15px;"></div>
                    <div class="solution-content" id="detailed-solution"></div>
                </div>
            </div>
        </div>

        <!-- M√ÄN H√åNH C√ÄI ƒê·∫∂T -->
        <div id="settings-screen" class="screen">
            <div class="settings-header"><h1 class="settings-title-text" style="text-align:center; font-family:'Barlow Condensed', sans-serif; font-weight: 900; color:#2980b9; font-size: 48px;">C√ÄI ƒê·∫∂T H·ªÜ TH·ªêNG</h1></div>
            
            <div class="settings-grid">
                <div class="settings-card card-class">
                    <p style="font-weight:900; color: #b03a2e; font-size: 22px; margin-bottom: 20px;">üë®‚Äçüéì QU·∫¢N L√ù L·ªöP H·ªåC</p>
                    <input type="text" id="admin-class-name" placeholder="Nh·∫≠p t√™n l·ªõp (V√≠ d·ª•: 6A1)">
                    <textarea id="admin-student-list" rows="3" placeholder="Nh·∫≠p danh s√°ch t√™n h·ªçc sinh (M·ªói t√™n 1 d√≤ng)..."></textarea>
                    <button class="btn btn-nav-custom" style="width:100%; margin-bottom: 20px;" onclick="window.saveClassData()">L∆ØU L·ªöP H·ªåC üíæ</button>
                    <div id="class-manager-list" class="manage-list" style="max-height: 120px; margin-bottom: 20px;"></div>
                    <select id="manage-class-select" onchange="window.renderStudentManager()" style="margin-bottom:10px;"><option value="">-- Ch·ªçn l·ªõp ƒë·ªÉ x√≥a h·ªçc sinh --</option></select>
                    <div id="student-manager-list" class="manage-list" style="max-height: 120px;"></div>
                </div>

                <div class="settings-card card-rank">
                    <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom: 20px;">
                        <p style="font-weight:900; color: #1e8449; font-size: 22px; margin:0;">üèÜ ƒêI·ªÇM C·∫§P B·∫¨C</p>
                        <!-- Th√™m n√∫t L∆∞u c·∫•u h√¨nh ƒëi·ªÉm (Style gi·ªëng n√∫t c·ªông) -->
                        <button class="btn-add-gift-cute" onclick="window.saveRankSettings()" title="L∆∞u thay ƒë·ªïi ƒëi·ªÉm">
                            <svg viewBox="0 0 24 24" style="width:20px;height:20px; fill:none; stroke:currentColor; stroke-width:2;">
                                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                                <polyline points="7 3 7 8 15 8"></polyline>
                            </svg>
                        </button>
                    </div>
                    <div id="rank-editor-container" style="background:rgba(255,255,255,0.4); padding:20px; border-radius:20px;"></div>
                </div>

                <div class="settings-card card-gift">
                    <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom: 20px;">
                        <p style="font-weight:900; color: #6c3483; font-size: 22px; margin:0;">üéÅ THI·∫æT L·∫¨P QU√Ä</p>
                        <button class="btn-add-gift-cute" onclick="window.addNewGift()" title="Th√™m qu√† m·ªõi">
                            <svg viewBox="0 0 24 24" style="width:20px;height:20px;"><path d="M12 5v14M5 12h14" stroke-linecap="round" stroke="currentColor" stroke-width="2"/></svg>
                        </button>
                    </div>
                    <div id="gift-config-area">
                        <div class="upload-wrapper">
                            <label>·∫¢nh qu√† t·∫∑ng th·ª±c t·∫ø:</label>
                            <input type="file" id="gift-image-input" accept="image/*" onchange="window.previewGiftImage(event)" class="custom-file-input">
                            <img id="image-preview-setup" src="">
                        </div>
                        <input type="text" id="gift-name-input" placeholder="Nh·∫≠p t√™n qu√† t·∫∑ng (V√≠ d·ª•: B√∫t bi, K·∫πo m√∫t...)">
                        <div style="display:flex; gap:15px; margin-bottom: 20px;">
                            <input type="number" id="gift-cost-input" placeholder="Gi√° ƒëi·ªÉm" style="flex:1;">
                            <select id="gift-rank-req-input" style="flex:1.5;"><option value="" disabled selected>c·∫•p ƒë·ªô</option></select>
                        </div>
                        <div id="gift-manager-list" class="manage-list" style="max-height: 150px;"></div>
                    </div>
                </div>

                <div class="settings-card card-sound">
                    <div style="display:flex; justify-content:space-between; align-items:center;"><p style="font-weight:900; color: #2980b9; font-size: 22px; margin:0;">üîä √ÇM THANH</p><label class="switch"><input type="checkbox" id="sound-master-toggle" checked onchange="window.toggleSoundMaster()"><span class="slider"></span></label></div>
                    <div id="sound-upload-section" style="margin-top:20px;">
                        <div class="upload-wrapper" style="border: 2px solid var(--secondary); background: #f0ffff;">
                            <label style="color: var(--secondary);">üéµ T·∫£i NH·∫†C N·ªÄN tr√≤ ch∆°i:</label>
                            <input type="file" accept="audio/*" onchange="window.uploadCustomSound(event, 'bg')" class="custom-file-input">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
                                <span style="font-size:12px; font-weight:800;">B·∫≠t nh·∫°c n·ªÅn:</span>
                                <label class="switch"><input type="checkbox" id="bg-music-toggle" checked onchange="window.toggleBgMusic()"><span class="slider"></span></label>
                            </div>
                            <div id="sound-status-bg" style="font-size:11px; color:var(--success); display:none; font-style:italic;">‚úì ƒê√£ t·∫£i nh·∫°c n·ªÅn</div>
                        </div>
                        <div class="upload-wrapper"><label>Nh·∫°c tr·∫£ l·ªùi ƒê√öNG:</label><input type="file" accept="audio/*" onchange="window.uploadCustomSound(event, 'correct')" class="custom-file-input"><div id="sound-status-correct" style="font-size:11px; color:var(--success); display:none;">‚úì ƒê√£ t·∫£i</div></div>
                        <div class="upload-wrapper"><label>Nh·∫°c tr·∫£ l·ªùi SAI:</label><input type="file" accept="audio/*" onchange="window.uploadCustomSound(event, 'wrong')" class="custom-file-input"><div id="sound-status-wrong" style="font-size:11px; color:var(--success); display:none;">‚úì ƒê√£ t·∫£i</div></div>
                        <button class="btn btn-nav-custom" style="width:100%; font-size:18px; margin-bottom: 15px;" onclick="window.resetAllSounds()">RESET √ÇM THANH</button>
                        
                        <!-- NEW: Toggle Focus Warning -->
                        <div style="display:flex; justify-content:space-between; align-items:center; border-top: 1px dashed #ccc; paddingTop: 15px;">
                            <span style="font-size:14px; font-weight:800; color: #e74c3c;">C·∫£nh b√°o m·∫•t t·∫≠p trung:</span>
                            <label class="switch"><input type="checkbox" id="focus-warning-toggle" checked onchange="window.toggleFocusWarning()"><span class="slider"></span></label>
                        </div>
                    </div>
                </div>
            </div>

            <div style="text-align:center; margin-top:40px; margin-bottom: 40px;"><button class="btn btn-nav-custom" onclick="window.openHome()">HO√ÄN T·∫§T & QUAY L·∫†I üè†</button></div>
        </div>

        <!-- ƒêƒÇNG NH·∫¨P -->
        <div id="setup-screen" class="screen">
            <div style="text-align: center; max-width: 600px; margin: 0 auto;">
                <p class="welcome-text">Xin ch√†o c√°c nh√† chinh ph·ª•c!</p>
                <div class="input-group"><label>Ch·ªçn l·ªõp h·ªçc:</label><select id="select-class" onchange="window.loadStudentList()"></select></div>
                <div id="student-selection-group" class="input-group" style="display:none;"><label>Ch·ªçn t√™n h·ªçc sinh:</label><select id="select-student"></select></div>
                <button class="btn btn-nav-custom" id="start-btn" style="display:none; width: 100%;" onclick="window.initGame()">B·∫ÆT ƒê·∫¶U CHINH PH·ª§C üöÄ</button>
            </div>
        </div>

        <!-- ƒê·ªîI QU√Ä -->
        <div id="shop-screen" class="screen">
            <div style="text-align: center; margin-bottom: 30px;"><h1 style="font-family: 'Barlow Condensed', sans-serif; font-weight: 900; color: #9b59b6; font-size: 48px;">üéÅ TRUNG T√ÇM ƒê·ªîI QU√Ä</h1></div>
            <div style="text-align: center; padding: 25px; background: white; border-radius: 35px; margin-bottom: 30px;"><h3 style="font-weight: 900; font-size: 26px;">ƒêI·ªÇM C·ª¶A EM: <span style="color: var(--primary); font-size: 1.5em;" id="shop-score-display">0</span></h3></div>
            <div class="gift-grid" id="shop-gift-container"></div>
            <div style="text-align: center; margin-top: 50px;"><button class="btn btn-nav-custom" onclick="window.backToGame()">QUAY L·∫†I üè†</button></div>
        </div>

        <!-- B·∫¢NG V√ÄNG -->
        <div id="leaderboard-screen" class="screen">
            <div class="leaderboard-header"><h1 style="font-family:'Barlow Condensed', sans-serif; font-weight: 900; color:#f1c40f; text-shadow: 2px 2px 0 #d35400; font-size: 48px;">üèÜ B·∫¢NG V√ÄNG TH√ÄNH T√çCH</h1></div>
            <div style="margin-bottom:15px; display:flex; gap:10px; align-items:center;"><label style="font-weight:800;">L·ªõp:</label><select id="lb-class" onchange="window.renderLB()" style="width: auto;"></select></div>
            <div id="lb-content"></div>
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-nav-custom" onclick="window.backToGame()">QUAY L·∫†I üè†</button>
                <button class="btn btn-nav-custom" style="background-color: var(--primary) !important; margin-left: 10px;" onclick="window.resetLeaderboardData()">XO√Å D·ªÆ LI·ªÜU üóëÔ∏è</button>
            </div>
        </div>

        <!-- FOOTER -->
        <div class="footer">
            <div class="footer-line-1">T√°c gi·∫£: GV H·ªì Th·ªã Lan</div>
            <div class="footer-line-2">
                <div class="footer-item"><svg class="footer-icon" viewBox="0 0 24 24"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/></svg><span>0829205583</span></div>
                <div class="footer-item"><svg class="footer-icon" viewBox="0 0 24 24"><path d="M12 2.04c-5.5 0-10 4.49-10 10.02 0 5.00 3.66 9.15 8.44 9.90v-7.00h-2.54v-2.90h2.54v-2.21c0-2.51 1.49-3.89 3.78-3.89 1.09 0 2.23.19 2.23.19v2.47h-1.26c-1.24 0-1.63.77-1.63 1.56v1.88h2.78l-.45 2.90h-2.33v7.00c4.78-.75 8.44-4.90 8.44-9.90 0-5.53-4.50-10.02-10-10.02z"/></svg><span>Facebook: H·ªì Lan</span></div>
                <div class="footer-item"><svg class="footer-icon" viewBox="0 0 24 24"><path d="M20,8L12,13L4,8V6L12,11L20,6M20,4H4C2.89,4 2,4.89 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V6C22,4.89 21.1,4 20,4Z"/></svg><span>Email: holan@moet.edu.vn</span></div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- DATABASE ---
    const countries = [
        { name: "Vi·ªát Nam", gmt: 7 }, { name: "Th√°i Lan", gmt: 7 }, { name: "Singapore", gmt: 8 },
        { name: "Trung Qu·ªëc", gmt: 8 }, { name: "Nh·∫≠t B·∫£n", gmt: 9 }, { name: "H√†n Qu·ªëc", gmt: 9 },
        { name: "√öc (Sydney)", gmt: 10 }, { name: "New Zealand", gmt: 12 }, { name: "Anh (London)", gmt: 0 },
        { name: "Ph√°p (Paris)", gmt: 1 }, { name: "Ai C·∫≠p", gmt: 2 }, { name: "Nga (Moscow)", gmt: 3 },
        { name: "UAE (Dubai)", gmt: 4 }, { name: "Hoa K·ª≥ (New York)", gmt: -5 }, { name: "Brazil", gmt: -3 },
        { name: "Hoa K·ª≥ (Los Angeles)", gmt: -8 }, { name: "Hoa K·ª≥ (Hawaii)", gmt: -10 }
    ];

    const beeBase = `<svg viewBox="0 0 100 100"><ellipse cx="35" cy="35" rx="15" ry="10" fill="#d1f2ff" opacity="0.8"/><ellipse cx="65" cy="35" rx="15" ry="10" fill="#d1f2ff" opacity="0.8"/><rect x="30" y="45" width="40" height="35" rx="15" fill="#f1c40f"/><path d="M30 55h40M30 65h40M30 75h40" stroke="#2d3436" stroke-width="4"/><circle cx="42" cy="55" r="3" fill="#2d3436"/><circle cx="58" cy="55" r="3" fill="#2d3436"/></svg>`;
    const beeArmored = `<svg viewBox="0 0 100 100"><ellipse cx="35" cy="35" rx="15" ry="10" fill="#d1f2ff" opacity="0.8"/><ellipse cx="65" cy="35" rx="15" ry="10" fill="#d1f2ff" opacity="0.8"/><rect x="30" y="45" width="40" height="35" rx="15" fill="#f1c40f"/><path d="M30 45a20 20 0 0 1 40 0l-5 10H35z" fill="#95a5a6" stroke="#2d3436"/><rect x="35" y="60" width="30" height="15" fill="#bdc3c7" stroke="#2d3436"/><circle cx="42" cy="55" r="3" fill="#2d3436"/><circle cx="58" cy="55" r="3" fill="#2d3436"/></svg>`;
    const beeScout = `<svg viewBox="0 0 100 100"><ellipse cx="35" cy="35" rx="15" ry="10" fill="#d1f2ff" opacity="0.8"/><ellipse cx="65" cy="35" rx="15" ry="10" fill="#d1f2ff" opacity="0.8"/><rect x="30" y="45" width="40" height="35" rx="15" fill="#2ecc71"/><path d="M35 50h30v8H35z" fill="#34495e"/><circle cx="42" cy="54" r="5" fill="#55efc4" stroke="#2d3436" stroke-width="1.5"/><circle cx="58" cy="54" r="5" fill="#55efc4" stroke="#2d3436" stroke-width="1.5"/></svg>`;
    const beeMutant = `<svg viewBox="0 0 100 100"><ellipse cx="35" cy="30" rx="18" ry="12" fill="#a29bfe" opacity="0.8"/><ellipse cx="65" cy="30" rx="18" ry="12" fill="#a29bfe" opacity="0.8"/><rect x="30" y="45" width="40" height="35" rx="15" fill="#8e44ad"/><path d="M30 55h40M30 65h40" stroke="#f1c40f" stroke-width="3"/><path d="M10 50l15-5M90 50l-15-5" stroke="#00d2d3" stroke-width="4" stroke-linecap="round"/><circle cx="42" cy="55" r="4" fill="#ff7675"/><circle cx="58" cy="55" r="4" fill="#ff7675"/></svg>`;
    const beeQueen = `<svg viewBox="0 0 100 100"><ellipse cx="30" cy="30" rx="22" ry="15" fill="#ffeaa7" opacity="0.9"/><ellipse cx="70" cy="30" rx="22" ry="15" fill="#ffeaa7" opacity="0.9"/><rect x="25" y="45" width="50" height="42" rx="20" fill="#f1c40f"/><path d="M35 40l7-15 8 15 8-15 7 15z" fill="#f1c40f" stroke="#d35400" stroke-width="3"/><circle cx="50" cy="18" r="4" fill="#e74c3c"/><path d="M35 55h30M35 65h30" stroke="#d35400" stroke-width="5"/><circle cx="43" cy="60" r="4" fill="#2d3436"/><circle cx="57" cy="60" r="4" fill="#2d3436"/></svg>`;

    // FIX: Chuy·ªÉn const ranks th√†nh let v√† t·∫£i t·ª´ localStorage ƒë·ªÉ l∆∞u ƒë∆∞·ª£c thay ƒë·ªïi
    const defaultRanks = [
        { name: "ONG TH∆Ø·ªúNG", min: 0, icon: beeBase, desc: "M√°u th·∫•p, s√°t th∆∞∆°ng nh·ªè, xu·∫•t hi·ªán s·ªë l∆∞·ª£ng l·ªõn" },
        { name: "ONG GI√ÅP", min: 50, icon: beeArmored, desc: "M√°u cao, di chuy·ªÉn ch·∫≠m, ch·ªãu ƒë√≤n t·ªët" },
        { name: "ONG TRINH S√ÅT", min: 150, icon: beeScout, desc: "Bay r·∫•t nhanh, kh√≥ tr√∫ng, √≠t m√°u" },
        { name: "ONG ƒê·ªòT BI·∫æN", min: 300, icon: beeMutant, desc: "M·∫°nh h∆°n, k·ªπ nƒÉng n√¢ng cao" },
        { name: "ONG CH√öA", min: 500, icon: beeQueen, desc: "M√°u r·∫•t cao, nhi·ªÅu k·ªπ nƒÉng, th·ªß lƒ©nh c·ªßa lo√†i ong" }
    ];
    let ranks = JSON.parse(localStorage.getItem('lan_game_ranks_bee_v1')) || defaultRanks;

    let classes = JSON.parse(localStorage.getItem('lan_game_classes') || '{}');
    let studentScores = JSON.parse(localStorage.getItem('lan_game_scores') || '{}');
    let gifts = JSON.parse(localStorage.getItem('lan_game_gifts')) || [{ id: 1, name: "Tr√†ng ph√°o tay", cost: 10, minRank: "ONG TH∆Ø·ªúNG", image: "" }];
    
    // Th√™m focusWarning v√†o setting (M·∫∑c ƒë·ªãnh l√† true)
    let audioSettings = JSON.parse(localStorage.getItem('lan_game_audio')) || { enabled: true, correct: "", wrong: "", levelup: "", bg: "", bgEnabled: true, focusWarning: true };

    let currentStudentKey = "";
    let curHour, curDate, correctAns, correctDate, fromCountry, toCountry;
    let uploadedImageBase64 = "";
    let seconds = 0, timerInterval;
    let audioCtx;
    let confirmCallback = null;
    
    // NEW: Game State Persistence
    let gameState = JSON.parse(localStorage.getItem('lan_game_state')) || { answered: false };

    // --- HELPER UI ---
    function notify(msg, color) { const b = document.getElementById('msg-box'); b.innerText = msg; b.style.background = color; b.style.display = 'block'; setTimeout(() => b.style.display = 'none', 3000); }
    
    function showConfirm(msg, callback) {
        document.getElementById('confirm-msg').innerText = msg;
        document.getElementById('confirm-modal').style.display = 'flex';
        confirmCallback = callback;
    }

    window.closeConfirmModal = function() {
        document.getElementById('confirm-modal').style.display = 'none';
        confirmCallback = null;
    }

    document.getElementById('confirm-yes-btn').onclick = function() {
        if (confirmCallback) confirmCallback();
        window.closeConfirmModal();
    };

    // --- CONFETTI LOGIC ---
    const confettiCanvas = document.getElementById('confetti-canvas');
    const confettiCtx = confettiCanvas.getContext('2d');
    let confettiParticles = [];
    
    function resizeConfetti() {
        confettiCanvas.width = window.innerWidth;
        confettiCanvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeConfetti);
    resizeConfetti();

    function fireConfetti() {
        confettiParticles = [];
        for (let i = 0; i < 150; i++) {
            confettiParticles.push({
                x: window.innerWidth / 2,
                y: window.innerHeight / 2,
                vx: (Math.random() - 0.5) * 20,
                vy: (Math.random() - 1) * 20 - 5,
                color: `hsl(${Math.random() * 360}, 100%, 50%)`,
                size: Math.random() * 10 + 5,
                gravity: 0.5,
                drag: 0.95
            });
        }
        requestAnimationFrame(updateConfetti);
    }

    function updateConfetti() {
        confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
        
        let alive = false;
        confettiParticles.forEach(p => {
            p.x += p.vx;
            p.y += p.vy;
            p.vy += p.gravity;
            p.vx *= p.drag;
            p.vy *= p.drag;
            
            confettiCtx.fillStyle = p.color;
            confettiCtx.fillRect(p.x, p.y, p.size, p.size);
            
            if (p.y < confettiCanvas.height) alive = true;
        });

        if (alive) requestAnimationFrame(updateConfetti);
    }

    // --- FOCUS CHECK ---
    document.addEventListener("visibilitychange", () => {
        if (document.hidden) {
            // User left the tab
        } else {
            // User came back
            if (audioSettings.focusWarning && document.getElementById('game-screen').classList.contains('active')) {
                document.getElementById('focus-warning-modal').style.display = 'flex';
                playSound('wrong'); // Play a sound to alert
            }
        }
    });
    
    function toggleFocusWarning() {
        audioSettings.focusWarning = document.getElementById('focus-warning-toggle').checked;
        saveToLocal();
        notify("ƒê√£ " + (audioSettings.focusWarning ? "B·∫¨T" : "T·∫ÆT") + " c·∫£nh b√°o!", "var(--sidebar-label-color)");
    }

    // --- AUDIO ---
    function playSound(type) {
        if (!audioSettings.enabled) return;
        let audio;
        if (type === 'correct' && audioSettings.correct) audio = new Audio(audioSettings.correct);
        else if (type === 'wrong' && audioSettings.wrong) audio = new Audio(audioSettings.wrong);
        else if (type === 'levelup' && audioSettings.levelup) audio = new Audio(audioSettings.levelup);
        else if (type === 'click') audio = document.getElementById('sound-click');
        else audio = document.getElementById(`sound-${type}-default`);
        if (audio) { audio.currentTime = 0; audio.play().catch(() => {}); }
    }
    function toggleSoundMaster() { audioSettings.enabled = document.getElementById('sound-master-toggle').checked; if (!audioSettings.enabled) pauseBgMusic(); else if (audioSettings.bgEnabled) playBgMusic(); saveToLocal(); }
    function toggleBgMusic() { audioSettings.bgEnabled = document.getElementById('bg-music-toggle').checked; if (audioSettings.bgEnabled && audioSettings.enabled) playBgMusic(); else pauseBgMusic(); saveToLocal(); }
    function playBgMusic() { if (!audioSettings.enabled || !audioSettings.bgEnabled || !audioSettings.bg) return; const bgAudio = document.getElementById('sound-bg-loop'); if (bgAudio.src !== audioSettings.bg) bgAudio.src = audioSettings.bg; bgAudio.play().catch(() => {}); }
    function pauseBgMusic() { document.getElementById('sound-bg-loop').pause(); }
    function uploadCustomSound(event, type) { const file = event.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (e) => { audioSettings[type] = e.target.result; saveToLocal(); document.getElementById(`sound-status-${type}`).style.display = 'block'; if (type === 'bg' && audioSettings.bgEnabled) playBgMusic(); notify("T·∫£i xong!", "var(--success)"); }; reader.readAsDataURL(file); } }
    
    function resetAllSounds() { 
        showConfirm("B·∫°n c√≥ ch·∫Øc mu·ªën Reset to√†n b·ªô c√†i ƒë·∫∑t √¢m thanh?", () => {
            audioSettings.correct = ""; audioSettings.wrong = ""; audioSettings.levelup = ""; audioSettings.bg = ""; saveToLocal(); 
            ['correct', 'wrong', 'levelup', 'bg'].forEach(t => {
                const el = document.getElementById(`sound-status-${t}`);
                if(el) el.style.display = 'none';
            }); 
            document.getElementById('sound-bg-loop').src = ""; 
            notify("Reset th√†nh c√¥ng!", "var(--welcome-blue)"); 
        });
    }

    // --- SOUND METER ---
    let analyser, microphone, isMetering = false;
    async function showSoundModal() {
        document.getElementById('sound-modal').style.display = 'flex';
        try {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') await audioCtx.resume();
            
            // Only request stream if we don't have it (or re-request)
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            
            analyser = audioCtx.createAnalyser(); 
            microphone = audioCtx.createMediaStreamSource(stream);
            analyser.fftSize = 256; 
            microphone.connect(analyser); 
            isMetering = true; 
            window.updateMeter();
        } catch (err) { 
            console.error(err);
            notify("C·∫ßn Microphone!", "var(--primary)"); 
            window.hideSoundModal(); 
        }
    }
    function updateMeter() { if (!isMetering) return; const array = new Uint8Array(analyser.frequencyBinCount); analyser.getByteFrequencyData(array); let avg = (array.reduce((a, b) => a + b, 0)) / array.length; let vol = Math.min(100, (avg / 128) * 100); document.getElementById('meter-bar').style.width = vol + "%"; document.getElementById('db-display').innerText = Math.round(avg) + " dB"; const txt = document.getElementById('noise-level-text'); if (vol < 30) { txt.innerText = "Y√äN Tƒ®NH"; txt.style.color = "var(--success)"; } else if (vol < 60) { txt.innerText = "H∆†I ·ªíN"; txt.style.color = "var(--sidebar-bg)"; } else { txt.innerText = "QU√Å ·ªíN!"; txt.style.color = "var(--primary)"; } requestAnimationFrame(updateMeter); }

    // --- CORE LOGIC ---
    function saveToLocal() { 
        localStorage.setItem('lan_game_classes', JSON.stringify(classes)); 
        localStorage.setItem('lan_game_scores', JSON.stringify(studentScores)); 
        localStorage.setItem('lan_game_gifts', JSON.stringify(gifts)); 
        localStorage.setItem('lan_game_audio', JSON.stringify(audioSettings)); 
        localStorage.setItem('lan_game_ranks_bee_v1', JSON.stringify(ranks));
        localStorage.setItem('lan_game_state', JSON.stringify(gameState));
    }
    
    function saveRankSettings() {
        saveToLocal();
        notify("ƒê√£ l∆∞u c·∫•u h√¨nh ƒëi·ªÉm!", "var(--success)");
    }

    function getRank(s) { let r = ranks[0]; for(let i=ranks.length-1; i>=0; i--) { if(s >= ranks[i].min) { r = ranks[i]; break; } } return r; }
    function loadStudentList() { const c = document.getElementById('select-class').value; if(!c) return document.getElementById('student-selection-group').style.display = 'none'; document.getElementById('select-student').innerHTML = classes[c].sort().map(n => `<option value="${n}">${n}</option>`).join(''); document.getElementById('student-selection-group').style.display = 'block'; document.getElementById('start-btn').style.display = 'block'; }
    function saveClassData() { const n = document.getElementById('admin-class-name').value.trim(); const l = document.getElementById('admin-student-list').value.split('\n').map(s=>s.trim()).filter(s=>s); if(!n || !l.length) return notify("ƒêi·ªÅn ƒë·ªß th√¥ng tin!", "var(--primary)"); classes[n] = classes[n] ? [...new Set([...classes[n], ...l])] : l; saveToLocal(); window.updateSelects(); window.renderClassManager(); document.getElementById('admin-class-name').value = ""; document.getElementById('admin-student-list').value = ""; notify("L∆∞u th√†nh c√¥ng!", "var(--success)"); }
    function updateSelects() { ['select-class', 'lb-class', 'manage-class-select', 'modal-rc-class', 'gift-rank-req-input', 'country-from', 'country-to'].forEach(id => { const el = document.getElementById(id); if (!el) return; const old = el.value; let opt = ''; if (id === 'gift-rank-req-input') opt = '<option value="" disabled selected>c·∫•p ƒë·ªô</option>' + ranks.map(r => `<option value="${r.name}">${r.name}</option>`).join(''); else if (id === 'country-from' || id === 'country-to') { opt = countries.map((c, i) => `<option value="${i}">${c.name} (GMT${c.gmt >= 0 ? '+' : ''}${c.gmt})</option>`).join(''); } else { opt = `<option value="">-- Ch·ªçn l·ªõp h·ªçc --</option>`; if (id === 'lb-class') opt += '<option value="ALL" selected>-- T·∫§T C·∫¢ C√ÅC L·ªöP --</option>'; opt += Object.keys(classes).sort().map(c => `<option value="${c}">${c}</option>`).join(''); } el.innerHTML = opt; if (id !== 'gift-rank-req-input' && id !== 'country-from' && id !== 'country-to') el.value = old; }); }
    function renderRankEditor() { const cont = document.getElementById('rank-editor-container'); cont.innerHTML = ranks.map((r, i) => `<div style="display:flex; flex-direction:column; gap:2px; margin-bottom:12px; border-bottom: 1px dashed #ddd; padding-bottom: 8px;"><div style="display:flex; align-items:center; gap:10px;"><div style="width:30px; height:30px; display:flex;">${r.icon}</div><span style="font-weight:800; min-width:130px; font-size:14px;">${r.name}</span><input type="number" value="${r.min}" class="rank-point-input" onchange="ranks[${i}].min=parseInt(this.value); window.renderRankEditor()"></div><span style="font-size:11px; font-style:italic; color:#aaa; margin-left:40px;">${r.desc}</span></div>`).join(''); }

    // --- GAME ACTIONS ---
    function initGame() { 
        const cls = document.getElementById('select-class').value; 
        const name = document.getElementById('select-student').value; 
        if(!cls || !name) return; 
        
        currentStudentKey = `${cls}_${name}`; 
        studentScores[currentStudentKey] = studentScores[currentStudentKey] || 0; 
        
        updateUI(); 
        switchScreen('game-screen'); 
        
        // Check game state on load
        if (gameState.answered) {
            // Restore answered state
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            submitBtn.style.opacity = '0.5';
            submitBtn.style.cursor = 'not-allowed';
            submitBtn.innerText = "ƒê√É N·ªòP ‚úîÔ∏è";
            document.getElementById('next-btn').style.display = 'inline-flex';
            ["ans-hour", "ans-day", "ans-month", "ans-year"].forEach(id => document.getElementById(id).disabled = true);
            
            // Restore question if possible (using saved or random for now since question state wasn't fully persisted before)
            // Ideally we'd save the specific question too, but randomization is acceptable for now if data is missing
            if (!document.getElementById('country-from').value) {
                 randomize(); // If clean slate, randomize
            } else {
                 updateCalculations(); // If inputs exist, update
            }
        } else {
            randomize();
        }
        
        playBgMusic(); 
    }
    
    function updateUI() { const s = studentScores[currentStudentKey] || 0; const r = getRank(s); document.getElementById('player-display').innerText = currentStudentKey.split('_')[1].toUpperCase(); document.getElementById('class-display').innerText = currentStudentKey.split('_')[0]; document.getElementById('player-score').innerText = s; document.getElementById('player-avatar').innerHTML = r.icon; document.getElementById('rank-display').innerText = r.name; document.getElementById('rank-desc-display').innerText = r.desc; }
    
    function submitAnswer() { 
        const aH = parseInt(document.getElementById('ans-hour').value); 
        const aD = parseInt(document.getElementById('ans-day').value); 
        const aM = parseInt(document.getElementById('ans-month').value); 
        const aY = parseInt(document.getElementById('ans-year').value); 
        
        if(isNaN(aH)||isNaN(aD)||isNaN(aM)||isNaN(aY)) return notify("ƒêI·ªÄN ƒê·ª¶ TH√îNG TIN!", "var(--primary)"); 
        
        const isCorrect = (aH === correctAns && aD === correctDate.getDate() && aM === (correctDate.getMonth()+1) && aY === correctDate.getFullYear()); 
        const oldRank = getRank(studentScores[currentStudentKey] || 0); 
        
        if(isCorrect) { 
            studentScores[currentStudentKey] += 10; 
            playSound('correct'); 
            showDetailedResult(true); 
        } else { 
            studentScores[currentStudentKey] -= 5; 
            playSound('wrong'); 
            showDetailedResult(false); 
        } 
        
        const newRank = getRank(studentScores[currentStudentKey]); 
        if (newRank.min > oldRank.min) { 
            playSound('levelup'); 
            fireConfetti(); 
            notify("EM ƒê√É TI·∫æN H√ìA TH√ÄNH " + newRank.name + " üèÜ", "var(--success)"); 
        } 
        
        // Save State as Answered
        gameState.answered = true;
        
        saveToLocal(); 
        updateUI(); 
        
        ["ans-hour", "ans-day", "ans-month", "ans-year"].forEach(id => document.getElementById(id).disabled = true); 
        
        const submitBtn = document.getElementById('submit-btn');
        submitBtn.disabled = true;
        submitBtn.style.opacity = '0.5';
        submitBtn.style.cursor = 'not-allowed';
        submitBtn.innerText = "ƒê√É N·ªòP ‚úîÔ∏è";
        
        document.getElementById('next-btn').style.display = 'inline-flex'; 
    }

    function randomize() { 
        // Reset State
        gameState.answered = false;
        saveToLocal();

        ["ans-hour", "ans-day", "ans-month", "ans-year"].forEach(id => { 
            const el = document.getElementById(id); 
            el.disabled = false; 
            el.value = ""; 
        }); 
        
        document.getElementById('result-area').style.display = 'none'; 
        
        const submitBtn = document.getElementById('submit-btn');
        submitBtn.disabled = false;
        submitBtn.style.opacity = '1';
        submitBtn.style.cursor = 'pointer';
        submitBtn.style.display = 'inline-flex';
        submitBtn.innerText = "N·ªòP B√ÄI üìù";

        document.getElementById('next-btn').style.display = 'none'; 
        
        if(!document.getElementById('country-from').options.length) window.updateSelects(); 
        document.getElementById('country-from').value = Math.floor(Math.random()*countries.length); 
        let tIdx; 
        do { tIdx = Math.floor(Math.random()*countries.length); } while(tIdx == document.getElementById('country-from').value); 
        document.getElementById('country-to').value = tIdx; 
        curHour = Math.floor(Math.random()*24); 
        curDate = new Date(2024, Math.floor(Math.random()*12), 1 + Math.floor(Math.random()*28)); 
        updateCalculations(); 
    }

    function updateCalculations() { fromCountry = countries[document.getElementById('country-from').value]; toCountry = countries[document.getElementById('country-to').value]; const targetDate = new Date(curDate); targetDate.setHours(curHour + (toCountry.gmt - fromCountry.gmt)); correctAns = targetDate.getHours(); correctDate = targetDate; document.getElementById('question-text').innerHTML = `<div style="font-family: Arial, sans-serif; color: #00008B;">N·∫øu <span style="color: #e74c3c; font-weight: 900;">${fromCountry.name.toUpperCase()} (GMT${fromCountry.gmt >= 0 ? '+' : ''}${fromCountry.gmt})</span> ƒëang l√† <b>${curHour} GI·ªú</b> ng√†y <b style="color: #e74c3c;">${curDate.getDate()}/${curDate.getMonth()+1}/${curDate.getFullYear()}</b>,<br> th√¨ ·ªü <span style="color: #e74c3c; font-weight: 900;">${toCountry.name.toUpperCase()} (GMT${toCountry.gmt >= 0 ? '+' : ''}${toCountry.gmt})</span> l√† m·∫•y gi·ªù, ng√†y n√†o?</div>`; }
    
    function showDetailedResult(isCorrect) { 
        const area = document.getElementById('result-area'); 
        const sol = document.getElementById('detailed-solution'); 
        area.style.display = 'block'; 
        area.className = isCorrect ? 'correct-box' : 'wrong-box'; 
        document.getElementById('result-message').innerText = isCorrect ? "üåü CH√çNH X√ÅC! TUY·ªÜT V·ªúI" : "‚ùå CH∆ØA ƒê√öNG R·ªíI! C·ªê G·∫ÆNG L√äN"; 
        
        const diff = toCountry.gmt - fromCountry.gmt; 
        const absDiff = Math.abs(diff);
        const op = diff >= 0 ? "+" : "-"; 
        const rawCalc = curHour + diff; 
        
        let step3HTML = "";
        
        if (rawCalc >= 24) {
            step3HTML = `Ta c√≥: <b>${curHour} ${op} ${absDiff} = ${rawCalc}</b>.<br>V√¨ k·∫øt qu·∫£ ‚â• 24 n√™n ta t√≠nh ti·∫øp: <b>${rawCalc} - 24 = ${correctAns} gi·ªù</b> v√† <b>TƒÇNG th√™m 1 ng√†y</b>.`;
        } else if (rawCalc < 0) {
            step3HTML = `Ta c√≥: <b>${curHour} ${op} ${absDiff} = ${rawCalc}</b>.<br>V√¨ k·∫øt qu·∫£ < 0 n√™n ta t√≠nh ti·∫øp: <b>${rawCalc} + 24 = ${correctAns} gi·ªù</b> v√† <b>L√ôI ƒëi 1 ng√†y</b>.`;
        } else {
            step3HTML = `Ta t√≠nh: <b>${curHour} ${op} ${absDiff} = ${correctAns} gi·ªù</b>. Ng√†y gi·ªØ nguy√™n.`;
        }
        
        sol.innerHTML = `<ul class="solution-list">
            <li class="solution-step step-1"><b>B∆∞·ªõc 1 - X√°c ƒë·ªãnh m√∫i gi·ªù:</b> ${fromCountry.name} (GMT ${fromCountry.gmt >= 0 ? '+' : ''}${fromCountry.gmt}) & ${toCountry.name} (GMT ${toCountry.gmt >= 0 ? '+' : ''}${toCountry.gmt}).</li>
            <li class="solution-step step-2"><b>B∆∞·ªõc 2 - T√≠nh ch√™nh l·ªách m√∫i gi·ªù:</b> Hai n∆∞·ªõc c√°ch nhau <b>${absDiff} gi·ªù</b>.</li>
            <li class="solution-step step-3"><b>B∆∞·ªõc 3 - T√≠nh gi·ªù v√† x√°c ƒë·ªãnh ng√†y:</b> V√¨ ${toCountry.name} ·ªü ph√≠a ${diff >= 0 ? 'ƒê√¥ng' : 'T√¢y'} so v·ªõi ${fromCountry.name}, n√™n:<br>${step3HTML}</li>
        </ul>
        <div class="final-answer-block">‚úÖ K·∫æT QU·∫¢ ƒê√öNG:<br>- Th·ªùi gian: <span class="ans-red"><b>${correctAns} GI·ªú</b></span><br>- Ng√†y th√°ng nƒÉm: <span class="ans-red"><b>Ng√†y ${correctDate.getDate()}/${correctDate.getMonth()+1}/${correctDate.getFullYear()}</b></span></div>`; 
    }

    // --- UI HELPERS ---
    function switchScreen(id) { 
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); 
        document.getElementById(id).classList.add('active'); 
        if (id === 'settings-screen') { 
            window.updateSelects(); 
            window.renderClassManager(); 
            window.renderRankEditor(); 
            window.renderGiftManager(); 
            document.getElementById('sound-master-toggle').checked = audioSettings.enabled; 
            document.getElementById('bg-music-toggle').checked = audioSettings.bgEnabled; 
            document.getElementById('focus-warning-toggle').checked = audioSettings.focusWarning; // Load toggle state
            ['correct','wrong','bg'].forEach(t => { const el = document.getElementById(`sound-status-${t}`); if(el) el.style.display = audioSettings[t] ? 'block' : 'none'; }); 
        } 
    }
    
    function openHome() { switchScreen('setup-screen'); }
    function backToGame() { switchScreen('game-screen'); }
    function showShop() { if(!currentStudentKey) return notify("H√ÉY ƒêƒÇNG NH·∫¨P!", "var(--primary)"); switchScreen('shop-screen'); window.renderShop(); }
    function showLeaderboard() { switchScreen('leaderboard-screen'); window.renderLB(); }
    function openSettings() { switchScreen('settings-screen'); }
    function hideSoundModal() { document.getElementById('sound-modal').style.display='none'; isMetering = false; }
    function hideTimerModal() { document.getElementById('timer-modal').style.display='none'; }
    function hideRandomCallModal() { document.getElementById('random-call-modal').style.display='none'; }
    function showTimerModal() { document.getElementById('timer-modal').style.display='flex'; }
    function showRandomCallModal() { document.getElementById('random-call-modal').style.display='flex'; window.updateSelects(); }
    function startTimer() { if(!timerInterval) timerInterval = setInterval(()=>{seconds++; let h=Math.floor(seconds/3600).toString().padStart(2,'0'); let m=Math.floor((seconds%3600)/60).toString().padStart(2,'0'); let s=(seconds%60).toString().padStart(2,'0'); document.getElementById('modalTimerDisplay').innerText=`${h}:${m}:${s}`;},1000); }
    function stopTimer() { clearInterval(timerInterval); timerInterval=null; }
    function resetTimer() { stopTimer(); seconds=0; document.getElementById('modalTimerDisplay').innerText="00:00:00"; }
    function pickRandomModal() { const cls = document.getElementById('modal-rc-class').value; if(!cls) return; const students = classes[cls]; const resEl = document.getElementById('modalRandomResult'); let count = 0; let interval = setInterval(() => { resEl.innerText = students[Math.floor(Math.random() * students.length)].toUpperCase(); count++; if(count > 15) { clearInterval(interval); playSound('correct'); } else playSound('click'); }, 80); }
    function renderClassManager() { const cont = document.getElementById('class-manager-list'); cont.innerHTML = Object.keys(classes).sort().map(c => `<div class="manage-item"><b>L·ªöP ${c}</b><button class="btn-delete-red" onclick="window.deleteClass('${c}')">XO√Å L·ªöP</button></div>`).join(''); }
    
    function deleteClass(c) { 
        showConfirm(`C·∫¢NH B√ÅO: B·∫°n c√≥ ch·∫Øc mu·ªën xo√° l·ªõp ${c}?\nTo√†n b·ªô ƒëi·ªÉm s·ªë c·ªßa h·ªçc sinh l·ªõp n√†y c≈©ng s·∫Ω b·ªã x√≥a kh·ªèi B·∫£ng v√†ng!`, () => {
            for (let key in studentScores) {
                if (key.startsWith(c + "_")) {
                    delete studentScores[key];
                }
            }
            delete classes[c]; 
            saveToLocal(); 
            window.renderClassManager(); 
            window.updateSelects(); 
            window.renderLB(); 
            notify("ƒê√£ xo√° l·ªõp " + c + " v√† to√†n b·ªô th√†nh t√≠ch!", "var(--primary)");
        });
    }

    function renderStudentManager() { const c = document.getElementById('manage-class-select').value; const cont = document.getElementById('student-manager-list'); if (!c) return cont.innerHTML = ""; cont.innerHTML = classes[c].map(n => `<div class="manage-item"><span>${n}</span><button class="btn-delete-red" onclick="window.deleteStudent('${c}','${n}')">XO√Å</button></div>`).join(''); }
    
    function deleteStudent(c, n) { 
        showConfirm(`Xo√° h·ªçc sinh ${n}?`, () => {
            const key = `${c}_${n}`;
            if (studentScores[key]) delete studentScores[key];
            classes[c] = classes[c].filter(x => x !== n); 
            saveToLocal(); 
            window.renderStudentManager(); 
            window.renderLB(); 
            notify("ƒê√£ xo√° h·ªçc sinh " + n, "var(--primary)");
        });
    }

    function previewGiftImage(event) { const file = event.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (e) => { uploadedImageBase64 = e.target.result; const img = document.getElementById('image-preview-setup'); img.src = uploadedImageBase64; img.style.display = 'block'; }; reader.readAsDataURL(file); } }
    function renderGiftManager() { const cont = document.getElementById('gift-manager-list'); cont.innerHTML = gifts.map(g => `<div class="manage-item"><span>${g.name}</span><button class="btn-delete-red" onclick="window.deleteGift(${g.id})">XO√Å</button></div>`).join(''); }
    function addNewGift() { const n = document.getElementById('gift-name-input').value; const c = parseInt(document.getElementById('gift-cost-input').value); const r = document.getElementById('gift-rank-req-input').value; if(n&&c&&r) { gifts.push({id:Date.now(), name:n, cost:c, minRank:r, image:uploadedImageBase64}); saveToLocal(); window.renderGiftManager(); document.getElementById('gift-name-input').value=""; document.getElementById('gift-cost-input').value=""; document.getElementById('image-preview-setup').style.display='none'; uploadedImageBase64=""; notify("ƒê√£ th√™m!", "var(--success)"); } }
    function deleteGift(id) { gifts = gifts.filter(g => g.id !== id); saveToLocal(); window.renderGiftManager(); }
    function renderLB() { const c = document.getElementById('lb-class').value || 'ALL'; const cont = document.getElementById('lb-content'); let list = []; for (let k in studentScores) { if(c==='ALL'||k.startsWith(c+'_')) { const s=studentScores[k]; list.push({n:k.split('_')[1], s, r:getRank(s)}); } } list.sort((a,b)=>b.s-a.s); cont.innerHTML = `<table class="leaderboard-table"><tr><th>H·∫°ng</th><th>T√™n</th><th>C·∫•p</th><th>ƒêi·ªÉm</th></tr>` + list.map((x,i)=>`<tr><td>${i+1}</td><td>${x.n}</td><td><div style="width:25px;height:25px;display:inline-block;vertical-align:middle;margin-right:10px;">${x.r.icon}</div></td><td>${x.s}</td></tr>`).join('') + `</table>`; }
    function resetLeaderboardData() {
        const cls = document.getElementById('lb-class').value;
        const isAll = cls === 'ALL' || !cls;
        const msg = isAll ? "C·∫¢NH B√ÅO: B·∫°n c√≥ ch·∫Øc mu·ªën XO√Å S·∫†CH to√†n b·ªô d·ªØ li·ªáu ƒëi·ªÉm tr√™n b·∫£ng v√†ng?" : `B·∫°n c√≥ ch·∫Øc mu·ªën xo√° d·ªØ li·ªáu ƒëi·ªÉm c·ªßa l·ªõp ${cls}?`;
        
        showConfirm(msg, () => {
            if (isAll) {
                studentScores = {};
            } else {
                for (let k in studentScores) {
                    if (k.startsWith(cls + "_")) {
                        delete studentScores[k];
                    }
                }
            }
            saveToLocal();
            renderLB();
            notify("ƒê√£ xo√° d·ªØ li·ªáu th√†nh c√¥ng!", "var(--success)");
        });
    }

    function renderShop() { const s = studentScores[currentStudentKey] || 0; document.getElementById('shop-score-display').innerText = s; const cont = document.getElementById('shop-gift-container'); cont.innerHTML = gifts.map(g => { const playerRank = getRank(s); const rIdx = ranks.findIndex(r => r.name === playerRank.name); const reqIdx = ranks.findIndex(r => r.name === g.minRank); const rankOk = rIdx >= reqIdx; const canAfford = s >= g.cost; return `<div class="gift-card" style="${!rankOk ? 'filter:grayscale(0.8);opacity:0.8;' : ''}"><div class="gift-image-box">${g.image ? `<img src="${g.image}">` : `<span style="font-size:40px;">üéÅ</span>`}</div><div class="gift-name">${g.name}</div><div class="gift-rank-req">C·∫ßn c·∫•p: ${g.minRank}</div><div class="gift-cost">${g.cost} ƒêI·ªÇM</div><button class="btn btn-nav-custom" style="width:100%; background-color:${(canAfford && rankOk) ? '' : '#ccc !important'};" onclick="window.buyGift('${g.id}',${g.cost})" ${(s < g.cost || !rankOk) ? 'disabled' : ''}>${!rankOk ? 'KH√ìA' : (canAfford ? 'ƒê·ªîI QU√Ä ‚ú®' : 'THI·∫æU ƒêI·ªÇM')}</button></div>`; }).join(''); }
    function buyGift(id, cost) { if(studentScores[currentStudentKey] >= cost) { studentScores[currentStudentKey] -= cost; saveToLocal(); updateUI(); window.renderShop(); playSound('correct'); notify("ƒê·ªïi qu√† th√†nh c√¥ng!", "var(--success)"); } }
    
    function resetClassScores() { 
        const c = currentStudentKey ? currentStudentKey.split('_')[0] : document.getElementById('select-class').value; 
        if(!c) return notify("VUI L√íNG CH·ªåN L·ªöP!", "var(--primary)"); 
        showConfirm(`ƒê·∫∑t l·∫°i ƒëi·ªÉm to√†n b·ªô l·ªõp ${c} v·ªÅ 0?`, () => {
            for (let k in studentScores) if (k.startsWith(c + "_")) studentScores[k] = 0; 
            saveToLocal(); 
            updateUI(); 
            notify("ƒê√£ reset ƒëi·ªÉm l·ªõp!", "var(--success)"); 
        });
    }

    // --- SIDEBAR DRAG SCROLL ---
    const sidebar = document.getElementById('left-sidebar');
    let isDown = false;
    let startY;
    let scrollDown;

    sidebar.addEventListener('mousedown', (e) => {
        isDown = true;
        sidebar.style.cursor = 'grabbing';
        startY = e.pageY - sidebar.offsetTop;
        scrollDown = sidebar.scrollTop;
    });

    sidebar.addEventListener('mouseleave', () => {
        isDown = false;
        sidebar.style.cursor = 'grab';
    });

    sidebar.addEventListener('mouseup', () => {
        isDown = false;
        sidebar.style.cursor = 'grab';
    });

    sidebar.addEventListener('mousemove', (e) => {
        if (!isDown) return;
        e.preventDefault();
        const y = e.pageY - sidebar.offsetTop;
        const walk = (y - startY) * 2; // Speed multiplier
        sidebar.scrollTop = scrollDown - walk;
    });

    // --- REGISTRATION ---
    window.showTimerModal = showTimerModal; window.showRandomCallModal = showRandomCallModal;
    window.loadStudentList = loadStudentList; window.initGame = initGame; window.submitAnswer = submitAnswer;
    window.showSoundModal = showSoundModal; window.hideSoundModal = hideSoundModal;
    window.hideTimerModal = hideTimerModal; window.hideRandomCallModal = hideRandomCallModal;
    window.openHome = openHome; window.openSettings = openSettings;
    window.showShop = showShop; window.backToGame = backToGame;
    window.showLeaderboard = showLeaderboard; window.startTimer = startTimer;
    window.stopTimer = stopTimer; window.resetTimer = resetTimer;
    window.toggleSoundMaster = toggleSoundMaster; window.uploadCustomSound = uploadCustomSound;
    window.resetAllSounds = resetAllSounds; window.saveClassData = saveClassData;
    window.deleteClass = deleteClass; window.deleteStudent = deleteStudent;
    window.renderStudentManager = renderStudentManager; window.previewGiftImage = previewGiftImage;
    window.addNewGift = addNewGift; window.deleteGift = deleteGift;
    window.renderLB = renderLB; window.buyGift = buyGift;
    window.exportToExcel = () => { let csv = "\uFEFFL·ªõp,T√™n,ƒêi·ªÉm\n"; for (let k in studentScores) csv += `${k.replace('_',',')},${studentScores[k]}\n`; const link = document.createElement("a"); link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' })); link.download = "ketqua.csv"; link.click(); };
    window.renderRankEditor = renderRankEditor; window.updateCalculations = updateCalculations; window.randomize = randomize; window.pickRandomModal = pickRandomModal;
    window.updateSelects = updateSelects; window.renderClassManager = renderClassManager; window.renderGiftManager = renderGiftManager; window.renderShop = renderShop;
    window.toggleBgMusic = toggleBgMusic; window.updateMeter = updateMeter;
    window.resetClassScores = resetClassScores;
    window.resetLeaderboardData = resetLeaderboardData; 
    window.saveRankSettings = saveRankSettings; // ƒêƒÉng k√Ω h√†m m·ªõi
    window.toggleFocusWarning = toggleFocusWarning;

    window.onload = () => { window.updateSelects(); window.renderClassManager(); window.renderRankEditor(); window.renderGiftManager(); };
</script>
</body>
</html>